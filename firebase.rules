rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null
        && request.auth.token.email in [
          'admin@newculturetrends.com'
        ];
    }

    match /items/{itemId} {
      allow read: if true;
      allow create, delete: if isAdmin();
      // Allow anonymous vote updates (increment votes by 1)
      // Handles both cases: votes exists or is null/undefined
      // Note: updatedAt is a serverTimestamp transform, not in data.keys()
      allow update: if isAdmin() ||
        (
          request.resource.data.keys().hasOnly(['votes']) &&
          (
            (resource.data.votes == null && request.resource.data.votes == 1) ||
            (resource.data.votes != null && request.resource.data.votes == resource.data.votes + 1)
          )
        );
    }

    match /itemVotes/{voteId} {
      // Allow anyone to read and create/update votes (IP-based, no auth required)
      // Note: Duplicate prevention is handled by transaction logic in the app
      // Transactions may use 'set' which can be treated as update
      allow read: if true;
      allow create, update: if true;
      allow delete: if isAdmin();
    }

    match /polls/{pollId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /pollVotes/{voteId} {
      // Allow anyone to read and create/update poll votes (IP-based, no auth required)
      // Note: Duplicate prevention is handled by transaction logic in the app
      // Transactions may use 'set' which can be treated as update
      allow read: if true;
      allow create, update: if true;
      allow delete: if isAdmin();
    }

    match /newsletter/{docId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }
  }
}

